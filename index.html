<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Story Maker - Publish and Read</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #f0f4ff;
    margin: 0; padding: 0;
    max-width: 700px;
    margin: auto;
    padding: 20px;
  }
  h1, h2, h3 {
    text-align: center;
  }
  textarea, input, select {
    width: 100%;
    font-size: 16px;
    margin: 8px 0;
    padding: 8px;
    box-sizing: border-box;
    border-radius: 5px;
    border: 1px solid #ccc;
  }
  button {
    padding: 10px 16px;
    font-size: 16px;
    border: none;
    background-color: #3f51b5;
    color: white;
    border-radius: 5px;
    cursor: pointer;
    margin-top: 10px;
  }
  button:hover {
    background-color: #303f9f;
  }
  .story-card {
    background: white;
    margin: 12px 0;
    padding: 15px;
    border-radius: 10px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  }
  .story-title {
    font-weight: bold;
    font-size: 20px;
    margin-bottom: 6px;
  }
  .creator-name {
    font-style: italic;
    color: #555;
    margin-bottom: 10px;
  }
  .rating {
    margin-top: 8px;
    font-weight: bold;
  }
  .rating-stars button {
    font-size: 24px;
    background: none;
    border: none;
    cursor: pointer;
    color: gold;
    padding: 0 3px;
  }
  .rating-stars button.disabled {
    cursor: default;
    color: #bbb;
  }
  #reader {
    background: white;
    padding: 20px;
    border-radius: 10px;
    margin-top: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  }
  #storyPage {
    font-size: 18px;
    min-height: 80px;
    margin-bottom: 12px;
    white-space: pre-line;
  }
  .nav-buttons {
    display: flex;
    justify-content: space-between;
  }
  .nav-buttons button {
    flex: 1;
    margin: 0 5px;
  }
  small {
    display: block;
    margin-top: 6px;
    color: #666;
  }
  label {
    font-weight: normal;
    display: inline-block;
    margin-right: 12px;
    user-select: none;
  }
  #setNameScreen {
    background: white;
    padding: 25px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    max-width: 400px;
    margin: 40px auto;
  }
</style>
</head>
<body>

<div id="setNameScreen" style="display:none;">
  <h2>Set Your Username</h2>
  <p>You must choose a unique username. This cannot be changed later.</p>
  <input type="text" id="userNameInput" placeholder="Enter your username" maxlength="20" />
  <button onclick="setUserName()">Set Username</button>
  <p id="nameError" style="color:red;"></p>
</div>

<div id="app" style="display:none;">
  <h1>Story Maker - Publish and Read</h1>

  <section id="createSection">
    <h2>Create a Story</h2>
    <input id="storyTitle" placeholder="Story Title" maxlength="50" />
    <input id="creatorName" disabled />
    <textarea id="storyContent" rows="6" placeholder="Write your story here. Each line is one page."></textarea>
    <div>
      <label><input type="radio" name="saveType" value="local" checked /> Save Locally (private)</label>
      <label><input type="radio" name="saveType" value="publish" /> Publish Publicly</label>
    </div>
    <button onclick="saveStory()">Save Story</button>
  </section>

  <section id="storiesSection">
    <h2>Stories</h2>
    <div id="storiesList"></div>
  </section>

  <section id="reader" style="display:none;">
    <h2 id="readerTitle"></h2>
    <div id="storyPage"></div>
    <small id="pageCount"></small>
    <div class="nav-buttons">
      <button onclick="prevPage()">Previous</button>
      <button onclick="nextPage()">Next</button>
    </div>
    <button style="margin-top:10px;" onclick="closeReader()">Close</button>
    <div id="ratingSection" style="margin-top:15px; display:none;">
      <div><strong>Rate this story:</strong></div>
      <div class="rating-stars" id="ratingStars"></div>
      <div class="rating" id="ratingInfo"></div>
    </div>
  </section>
</div>

<script>
  // Constants for localStorage keys
  const LOCAL_KEY = 'funnyStories_local';
  const PUBLISHED_KEY = 'funnyStories_published';
  const RATINGS_KEY = 'funnyStories_ratings';
  const USERNAME_KEY = 'funnyStories_username';

  // Bad words list
  const badWords = ["badword", "crap", "damn", "hell", "shit", "stupid"];

  // Global vars
  let localStories = JSON.parse(localStorage.getItem(LOCAL_KEY) || '[]');
  let publishedStories = JSON.parse(localStorage.getItem(PUBLISHED_KEY) || '[]');
  let ratings = JSON.parse(localStorage.getItem(RATINGS_KEY) || '{}');
  let currentStory = null;
  let currentPage = 0;

  // Initialize
  function init() {
    const savedName = localStorage.getItem(USERNAME_KEY);
    if (!savedName) {
      document.getElementById('setNameScreen').style.display = 'block';
      document.getElementById('app').style.display = 'none';
    } else {
      startApp(savedName);
    }
  }

  // Set username, check uniqueness
  function setUserName() {
    const input = document.getElementById('userNameInput');
    const name = input.value.trim();
    const errorEl = document.getElementById('nameError');

    if(name.length < 3) {
      errorEl.textContent = "Username must be at least 3 characters.";
      return;
    }

    // Check uniqueness in published stories creator names
    const nameLower = name.toLowerCase();
    const nameTaken = publishedStories.some(s => s.creator.toLowerCase() === nameLower);

    if(nameTaken) {
      errorEl.textContent = "This username is already taken by another published story creator.";
      return;
    }

    // Save and proceed
    localStorage.setItem(USERNAME_KEY, name);
    startApp(name);
  }

  // Start app with username
  function startApp(userName) {
    document.getElementById('setNameScreen').style.display = 'none';
    document.getElementById('app').style.display = 'block';

    const creatorInput = document.getElementById('creatorName');
    creatorInput.value = userName;
    creatorInput.disabled = true;

    renderStories();
  }

  // Sanitize bad words
  function sanitize(text) {
    let words = text.split(/\b/);
    return words.map(w => {
      return badWords.includes(w.toLowerCase()) ? '*'.repeat(w.length) : w;
    }).join('');
  }

  // Generate unique ID
  function generateId() {
    return 'story_' + Math.random().toString(36).substr(2,9);
  }

  // Save story function
  function saveStory() {
    const titleRaw = document.getElementById('storyTitle').value.trim();
    const contentRaw = document.getElementById('storyContent').value.trim();
    const saveType = document.querySelector('input[name="saveType"]:checked').value;
    const userName = localStorage.getItem(USERNAME_KEY);

    if(!titleRaw || !contentRaw) {
      alert("Please enter a title and story content.");
      return;
    }

    const title = sanitize(titleRaw);
    const pages = contentRaw.split('\n').map(line => sanitize(line.trim())).filter(l => l.length > 0);
    if(pages.length < 2) {
      alert("Please enter at least two pages (lines) of story content.");
      return;
    }

    const storyObj = {
      id: generateId(),
      title,
      creator: userName,
      pages,
      published: saveType === 'publish'
    };

    if(saveType === 'publish') {
      // Check if creator name already used by another published story? Not required, user can have multiple stories.
      publishedStories.push(storyObj);
      localStorage.setItem(PUBLISHED_KEY, JSON.stringify(publishedStories));
      alert("Story published! Everyone can see it now.");
    } else {
      localStories.push(storyObj);
      localStorage.setItem(LOCAL_KEY, JSON.stringify(localStories));
      alert("Story saved locally. Only you can see it.");
    }

    // Clear inputs
    document.getElementById('storyTitle').value = '';
    document.getElementById('storyContent').value = '';
    document.querySelector('input[name="saveType"][value="local"]').checked = true;

    renderStories();
  }

  // Render stories list
  function renderStories() {
    const container = document.getElementById('storiesList');
    container.innerHTML = '';

    if(localStories.length > 0) {
      const localTitle = document.createElement('h3');
      localTitle.textContent = "Your Local Stories (Private)";
      container.appendChild(localTitle);
      localStories.forEach((story, i) => {
        container.appendChild(createStoryCard(story, false, i));
      });
    }

    if(publishedStories.length > 0) {
      const pubTitle = document.createElement('h3');
      pubTitle.textContent = "Published Stories (Public)";
      container.appendChild(pubTitle);
      publishedStories.forEach((story, i) => {
        container.appendChild(createStoryCard(story, true, i));
      });
    }

    if(localStories.length === 0 && publishedStories.length === 0) {
      container.textContent = "No stories saved yet. Create one above!";
    }
  }

  // Create story card element
  function createStoryCard(story, isPublished, index) {
    const card = document.createElement('div');
    card.className = 'story-card';

    // Title
    const titleEl = document.createElement('div');
    titleEl.className = 'story-title';
    titleEl.textContent = story.title;
    card.appendChild(titleEl);

    // Creator (only published)
    if(isPublished) {
      const creatorEl = document.createElement('div');
      creatorEl.className = 'creator-name';
      creatorEl.textContent = 'By: ' + story.creator;
      card.appendChild(creatorEl);
    }

    // Buttons container
    const btnContainer = document.createElement('div');

    // Read button
    const readBtn = document.createElement('button');
    readBtn.textContent = "Read";
    readBtn.onclick = () => openStory(story, isPublished, index);
    btnContainer.appendChild(readBtn);

    // Delete button for your own stories only
    const userName = localStorage.getItem(USERNAME_KEY);
    if((!isPublished && story.creator === userName) || (isPublished && story.creator === userName)) {
      const delBtn = document.createElement('button');
      delBtn.textContent = "Delete";
      delBtn.style.backgroundColor = '#e53935';
      delBtn.onclick = () => {
        if(confirm('Delete this story?')) {
          if(isPublished) {
            publishedStories.splice(index,1);
            localStorage.setItem(PUBLISHED_KEY, JSON.stringify(publishedStories));
          } else {
            localStories.splice(index,1);
            localStorage.setItem(LOCAL_KEY, JSON.stringify(localStories));
          }
          renderStories();
          if(currentStory && currentStory.id === story.id) closeReader();
        }
      };
      btnContainer.appendChild(delBtn);
    }

    card.appendChild(btnContainer);

    // Show average rating if published
    if(isPublished) {
      const avg = getAverageRating(story.id);
      const ratingInfo = document.createElement('div');
      ratingInfo.className = 'rating';
      ratingInfo.textContent = avg !== null ? `Average rating: ${avg.toFixed(2)} / 5` : 'No ratings yet';
      card.appendChild(ratingInfo);
    }

    return card;
  }

  // Open story reader
  function openStory(story, isPublished, index) {
    currentStory = story;
    currentPage = 0;
    document.getElementById('readerTitle').textContent = story.title;
    updatePage();
    document.getElementById('reader').style.display = 'block';

    // Show rating if published
    const ratingSection = document.getElementById('ratingSection');
    if(isPublished) {
      ratingSection.style.display = 'block';
      setupRating(story.id);
    } else {
      ratingSection.style.display = 'none';
    }
  }

  // Update story page and page count
  function updatePage() {
    document.getElementById('storyPage').textContent = currentStory.pages[currentPage];
    document.getElementById('pageCount').textContent = `Page ${currentPage + 1} of ${currentStory.pages.length}`;
  }

  // Navigation
  function nextPage() {
    if(currentPage < currentStory.pages.length - 1) {
      currentPage++;
      updatePage();
    }
  }
  function prevPage() {
    if(currentPage > 0) {
      currentPage--;
      updatePage();
    }
  }

  // Close reader
  function closeReader() {
    document.getElementById('reader').style.display = 'none';
    currentStory = null;
    currentPage = 0;
  }

  // Rating logic
  const RATINGS_KEY = 'funnyStories_ratings';

  let ratings = JSON.parse(localStorage.getItem(RATINGS_KEY) || '{}');

  function setupRating(storyId) {
    const container = document.getElementById('ratingStars');
    container.innerHTML = '';

    let userRating = getUserRating(storyId);
    const maxStars = 5;

    for(let i=1; i<=maxStars; i++) {
      const starBtn = document.createElement('button');
      starBtn.innerHTML = '&#9733;'; // star symbol
      if(userRating && i <= userRating) {
        starBtn.style.color = 'gold';
      } else {
        starBtn.style.color = '#ccc';
      }
      // Disable if already rated
      if(userRating) {
        starBtn.classList.add('disabled');
      } else {
        starBtn.onclick = () => {
          setRating(storyId, i);
          setupRating(storyId);
          renderStories();
        };
      }
      container.appendChild(starBtn);
    }

    // Show rating info
    const ratingInfo = document.getElementById('ratingInfo');
    const avg = getAverageRating(storyId);
    ratingInfo.textContent = avg !== null ? `Average rating: ${avg.toFixed(2)} / 5` : 'No ratings yet';
  }

  // Get user rating for a story
  function getUserRating(storyId) {
    const userId = localStorage.getItem('funnyStories_username');
    if(ratings[storyId] && ratings[storyId][userId]) {
      return ratings[storyId][userId];
    }
    return null;
  }

  // Set rating for a story by user
  function setRating(storyId, ratingValue) {
    const userId = localStorage.getItem('funnyStories_username');
    if(!ratings[storyId]) ratings[storyId] = {};
    if(!ratings[storyId][userId]) {
      ratings[storyId][userId] = ratingValue;
      localStorage.setItem(RATINGS_KEY, JSON.stringify(ratings));
    }
  }

  // Calculate average rating for a story
  function getAverageRating(storyId) {
    if(!ratings[storyId]) return null;
    const vals = Object.values(ratings[storyId]);
    if(vals.length === 0) return null;
    const sum = vals.reduce((a,b) => a+b, 0);
    return sum / vals.length;
  }

  init();

</script>

</body>
</html>
