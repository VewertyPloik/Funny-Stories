<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Story Maker - Publish and Read</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #f0f4ff;
    margin: 0; padding: 0;
    max-width: 700px;
    margin: auto;
    padding: 20px;
  }
  h1, h2, h3 {
    text-align: center;
  }
  textarea, input {
    width: 100%;
    font-size: 16px;
    margin: 8px 0;
    padding: 8px;
    box-sizing: border-box;
    border-radius: 5px;
    border: 1px solid #ccc;
  }
  button {
    padding: 10px 16px;
    font-size: 16px;
    border: none;
    background-color: #3f51b5;
    color: white;
    border-radius: 5px;
    cursor: pointer;
    margin-top: 10px;
  }
  button:hover:not(.disabled) {
    background-color: #303f9f;
  }
  button.disabled {
    cursor: default;
    background-color: #999 !important;
  }
  .story-card {
    background: white;
    margin: 12px 0;
    padding: 15px;
    border-radius: 10px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  }
  .story-title {
    font-weight: bold;
    font-size: 20px;
    margin-bottom: 6px;
  }
  .creator-name {
    font-style: italic;
    color: #555;
    margin-bottom: 10px;
  }
  .rating {
    margin-top: 8px;
    font-weight: bold;
  }
  .rating-stars button {
    font-size: 24px;
    background: none;
    border: none;
    cursor: pointer;
    color: gold;
    padding: 0 3px;
  }
  #reader {
    background: white;
    padding: 20px;
    border-radius: 10px;
    margin-top: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  }
  #storyPage {
    font-size: 18px;
    min-height: 80px;
    margin-bottom: 12px;
    white-space: pre-line;
  }
  .nav-buttons {
    display: flex;
    justify-content: space-between;
  }
  .nav-buttons button {
    flex: 1;
    margin: 0 5px;
  }
  small {
    display: block;
    margin-top: 6px;
    color: #666;
  }
  label {
    font-weight: normal;
    display: inline-block;
    margin-right: 12px;
    user-select: none;
  }
  #setNameScreen {
    background: white;
    padding: 25px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    max-width: 400px;
    margin: 40px auto;
  }
</style>
</head>
<body>

<div id="setNameScreen" >
  <h2>Set Your Username</h2>
  <p>You must choose a unique username. This cannot be changed later.</p>
  <input type="text" id="userNameInput" placeholder="Enter your username" maxlength="20" />
  <button id="setNameBtn">Set Username</button>
  <p id="nameError" style="color:red;"></p>
</div>

<div id="app" style="display:none;">
  <h1>Story Maker - Publish and Read</h1>

  <section id="createSection">
    <h2>Create a Story</h2>
    <input id="storyTitle" placeholder="Story Title" maxlength="50" />
    <input id="creatorName" disabled />
    <textarea id="storyContent" rows="6" placeholder="Write your story here. Each line is one page."></textarea>
    <div>
      <label><input type="radio" name="saveType" value="local" checked /> Save Locally (private)</label>
      <label><input type="radio" name="saveType" value="publish" /> Publish Publicly</label>
    </div>
    <button id="saveStoryBtn">Save Story</button>
  </section>

  <section id="storiesSection">
    <h2>Stories</h2>
    <div id="storiesList"></div>
  </section>

  <section id="reader" style="display:none;">
    <h2 id="readerTitle"></h2>
    <div id="storyPage"></div>
    <small id="pageCount"></small>
    <div class="nav-buttons">
      <button id="prevPageBtn">Previous</button>
      <button id="nextPageBtn">Next</button>
    </div>
    <button style="margin-top:10px;" id="closeReaderBtn">Close</button>
    <div id="ratingSection" style="margin-top:15px; display:none;">
      <div><strong>Rate this story:</strong></div>
      <div class="rating-stars" id="ratingStars"></div>
      <div class="rating" id="ratingInfo"></div>
    </div>
  </section>
</div>

<script>
  // Constants for localStorage keys
  const LOCAL_KEY = 'funnyStories_local';
  const PUBLISHED_KEY = 'funnyStories_published';
  const RATINGS_KEY = 'funnyStories_ratings';
  const USERNAME_KEY = 'funnyStories_username';

  // Bad words list
  const badWords = ["badword", "crap", "damn", "hell", "shit", "stupid"];

  // Globals
  let localStories = JSON.parse(localStorage.getItem(LOCAL_KEY) || '[]');
  let publishedStories = JSON.parse(localStorage.getItem(PUBLISHED_KEY) || '[]');
  let ratings = JSON.parse(localStorage.getItem(RATINGS_KEY) || '{}');
  let currentStory = null;
  let currentPage = 0;

  const setNameScreen = document.getElementById('setNameScreen');
  const appDiv = document.getElementById('app');
  const userNameInput = document.getElementById('userNameInput');
  const nameError = document.getElementById('nameError');
  const creatorNameInput = document.getElementById('creatorName');
  const storyTitleInput = document.getElementById('storyTitle');
  const storyContentInput = document.getElementById('storyContent');
  const saveStoryBtn = document.getElementById('saveStoryBtn');
  const storiesList = document.getElementById('storiesList');
  const readerSection = document.getElementById('reader');
  const readerTitle = document.getElementById('readerTitle');
  const storyPage = document.getElementById('storyPage');
  const pageCount = document.getElementById('pageCount');
  const prevPageBtn = document.getElementById('prevPageBtn');
  const nextPageBtn = document.getElementById('nextPageBtn');
  const closeReaderBtn = document.getElementById('closeReaderBtn');
  const ratingSection = document.getElementById('ratingSection');
  const ratingStars = document.getElementById('ratingStars');
  const ratingInfo = document.getElementById('ratingInfo');
  const setNameBtn = document.getElementById('setNameBtn');

  // Helper functions

  function sanitize(text) {
    let words = text.split(/\b/);
    return words.map(w => {
      return badWords.includes(w.toLowerCase()) ? '*'.repeat(w.length) : w;
    }).join('');
  }

  function generateId() {
    return 'story_' + Math.random().toString(36).substr(2, 9);
  }

  // Set user name, validate uniqueness
  setNameBtn.onclick = () => {
    const name = userNameInput.value.trim();
    if(name.length < 3) {
      nameError.textContent = "Username must be at least 3 characters.";
      return;
    }
    const nameLower = name.toLowerCase();
    if(publishedStories.some(s => s.creator.toLowerCase() === nameLower)) {
      nameError.textContent = "This username is already taken by a published story creator.";
      return;
    }
    localStorage.setItem(USERNAME_KEY, name);
    startApp(name);
  };

  // Initialize app or ask username
  function init() {
    const savedName = localStorage.getItem(USERNAME_KEY);
    if(!savedName) {
      setNameScreen.style.display = 'block';
      appDiv.style.display = 'none';
    } else {
      startApp(savedName);
    }
  }

  // Start main app UI
  function startApp(userName) {
    setNameScreen.style.display = 'none';
    appDiv.style.display = 'block';

    creatorNameInput.value = userName;

    // Event listeners for story saving
    saveStoryBtn.onclick = saveStory;
    prevPageBtn.onclick = prevPage;
    nextPageBtn.onclick = nextPage;
    closeReaderBtn.onclick = closeReader;

    renderStories();
  }

  // Save a story
  function saveStory() {
    const titleRaw = storyTitleInput.value.trim();
    const contentRaw = storyContentInput.value.trim();
    const saveType = document.querySelector('input[name="saveType"]:checked').value;
    const userName = localStorage.getItem(USERNAME_KEY);

    if(!titleRaw || !contentRaw) {
      alert("Please enter a title and story content.");
      return;
    }

    const title = sanitize(titleRaw);
    const pages = contentRaw.split('\n').map(line => sanitize(line.trim())).filter(l => l.length > 0);
    if(pages.length < 2) {
      alert("Please enter at least two pages (lines) of story content.");
      return;
    }

    const storyObj = {
      id: generateId(),
      title,
      creator: userName,
      pages,
      published: saveType === 'publish'
    };

    if(storyObj.published) {
      publishedStories.push(storyObj);
      localStorage.setItem(PUBLISHED_KEY, JSON.stringify(publishedStories));
      alert("Story published! Everyone can see it now.");
    } else {
      localStories.push(storyObj);
      localStorage.setItem(LOCAL_KEY, JSON.stringify(localStories));
      alert("Story saved locally. Only you can see it.");
    }

    storyTitleInput.value = '';
    storyContentInput.value = '';
    document.querySelector('input[name="saveType"][value="local"]').checked = true;

    renderStories();
  }

  // Render stories
  function renderStories() {
    storiesList.innerHTML = '';

    if(localStories.length > 0) {
      const localTitle = document.createElement('h3');
      localTitle.textContent = "Your Local Stories (Private)";
      storiesList.appendChild(localTitle);
      localStories.forEach((story, i) => {
        storiesList.appendChild(createStoryCard(story, false, i));
      });
    }

    if(publishedStories.length > 0) {
      const pubTitle = document.createElement('h3');
      pubTitle.textContent = "Published Stories (Public)";
      storiesList.appendChild(pubTitle);
      publishedStories.forEach((story, i) => {
        storiesList.appendChild(createStoryCard(story, true, i));
      });
    }

    if(localStories.length === 0 && publishedStories.length === 0) {
      storiesList.textContent = "No stories saved yet. Create one above!";
    }
  }

  // Create a story card
  function createStoryCard(story, isPublished, index) {
    const card = document.createElement('div');
    card.className = 'story-card';

    const titleEl = document.createElement('div');
    titleEl.className = 'story-title';
    titleEl.textContent = story.title;
    card.appendChild(titleEl);

    if(isPublished) {
      const creatorEl = document.createElement('div');
      creatorEl.className = 'creator-name';
      creatorEl.textContent = 'By: ' + story.creator;
      card.appendChild(creatorEl);
    }

    const btnContainer = document.createElement('div');

    const readBtn = document.createElement('button');
    readBtn.textContent = "Read";
    readBtn.onclick = () => openStory(story, isPublished, index);
    btnContainer.appendChild(readBtn);

    const userName = localStorage.getItem(USERNAME_KEY);
    if(story.creator === userName) {
      const delBtn = document.createElement('button');
      delBtn.textContent = "Delete";
      delBtn.style.backgroundColor = '#e53935';
      delBtn.onclick = () => {
        if(confirm('Delete this story?')) {
          if(isPublished) {
            publishedStories.splice(index, 1);
            localStorage.setItem(PUBLISHED_KEY, JSON.stringify(publishedStories));
          } else {
            localStories.splice(index, 1);
            localStorage.setItem(LOCAL_KEY, JSON.stringify(localStories));
          }
          renderStories();
          if(currentStory && currentStory.id === story.id) closeReader();
        }
      };
      btnContainer.appendChild(delBtn);
    }

    card.appendChild(btnContainer);

    // Show average rating for published
    if(isPublished) {
      const avg = getAverageRating(story.id);
      const ratingInfoEl = document.createElement('div');
      ratingInfoEl.className = 'rating';
      ratingInfoEl.textContent = avg !== null ? `Average rating: ${avg.toFixed(2)} / 5` : 'No ratings yet';
      card.appendChild(ratingInfoEl);
    }

    return card;
  }

  // Open story reading panel
  function openStory(story, isPublished, index) {
    currentStory = story;
    currentPage = 0;
    readerTitle.textContent = story.title;
    updatePage();
    readerSection.style.display = 'block';

    if(isPublished) {
      ratingSection.style.display = 'block';
      setupRating(story.id);
    } else {
      ratingSection.style.display = 'none';
    }
  }

  // Update story page display
  function updatePage() {
    storyPage.textContent = currentStory.pages[currentPage];
    pageCount.textContent = `Page ${currentPage + 1} of ${currentStory.pages.length}`;
    prevPageBtn.disabled = (currentPage === 0);
    nextPageBtn.disabled = (currentPage === currentStory.pages.length - 1);
    prevPageBtn.classList.toggle('disabled', prevPageBtn.disabled);
    nextPageBtn.classList.toggle('disabled', nextPageBtn.disabled);
  }

  function nextPage() {
    if(currentPage < currentStory.pages.length - 1) {
      currentPage++;
      updatePage();
    }
  }

  function prevPage() {
    if(currentPage > 0) {
      currentPage--;
      updatePage();
    }
  }

  function closeReader() {
    readerSection.style.display = 'none';
    currentStory = null;
    currentPage = 0;
  }

  // Rating logic
  function setupRating(storyId) {
    ratingStars.innerHTML = '';
    const userId = localStorage.getItem(USERNAME_KEY);
    let userRating = getUserRating(storyId);
    const maxStars = 5;

    for(let i=1; i<=maxStars; i++) {
      const starBtn = document.createElement('button');
      starBtn.innerHTML = '&#9733;';
      if(userRating && i <= userRating) {
        starBtn.style.color = 'gold';
        starBtn.classList.add('disabled');
      } else {
        starBtn.style.color = '#ccc';
        starBtn.classList.remove('disabled');
      }
      if(!userRating) {
        starBtn.onclick = () => {
          setRating(storyId, i);
          setupRating(storyId);
          renderStories();
        };
      }
      ratingStars.appendChild(starBtn);
    }

    const avg = getAverageRating(storyId);
    ratingInfo.textContent = avg !== null ? `Average rating: ${avg.toFixed(2)} / 5` : 'No ratings yet';
  }

  function getUserRating(storyId) {
    const userId = localStorage.getItem(USERNAME_KEY);
    if(ratings[storyId] && ratings[storyId][userId]) {
      return ratings[storyId][userId];
    }
    return null;
  }

  function setRating(storyId, ratingValue) {
    const userId = localStorage.getItem(USERNAME_KEY);
    if(!ratings[storyId]) ratings[storyId] = {};
    if(!ratings[storyId][userId]) {
      ratings[storyId][userId] = ratingValue;
      localStorage.setItem(RATINGS_KEY, JSON.stringify(ratings));
    }
  }

  function getAverageRating(storyId) {
    if(!ratings[storyId]) return null;
    const vals = Object.values(ratings[storyId]);
    if(vals.length === 0) return null;
    const sum = vals.reduce((a,b) => a+b, 0);
    return sum / vals.length;
  }

  // Run init on page load
  window.onload = init;

</script>

</body>
</html>
